Gamepad=function(){this.gamepads=[];this.listeners={};this.platform=null;this.deadzone=.03;this.maximizeThreshold=.97};Gamepad.Platform={UNSUPPORTED:"unsupported",WEBKIT:"webkit",FIREFOX:"firefox"};Gamepad.Type={PLAYSTATION:"playstation",LOGITECH:"logitech",XBOX:"xbox",UNSUPPORTED:"unsupported"};Gamepad.Event={CONNECTED:"connected",DISCONNECTED:"disconnected",TICK:"tick",UNSUPPORTED:"unsupported",BUTTON_DOWN:"buttonDown",BUTTON_UP:"buttonUp"};Gamepad.Mapping={PLAYSTATION_FIREFOX:{buttons:{CROSS:14,CIRCLE:13,SQUARE:15,TRIANGLE:12,LB1:10,RB1:11,LEFT_STICK:1,RIGHT_STICK:2,START:3,SELECT:0,HOME:16,DPAD_UP:4,DPAD_DOWN:6,DPAD_LEFT:7,DPAD_RIGHT:5},axes:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3}},PLAYSTATION_WEBKIT:{buttons:{CROSS:0,CIRCLE:1,SQUARE:2,TRIANGLE:3,LB1:4,RB1:5,LB2:6,RB2:7,LEFT_STICK:10,RIGHT_STICK:11,START:9,SELECT:8,HOME:16,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15},axes:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3}},LOGITECH_FIREFOX:{buttons:{A:0,B:1,X:2,Y:3,LB:4,RB:5,LEFT_STICK:8,RIGHT_STICK:9,START:7,BACK:6,HOME:10,DPAD_UP:11,DPAD_DOWN:12,DPAD_LEFT:13,DPAD_RIGHT:14},axes:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:3,RIGHT_STICK_Y:4,LEFT_TRIGGER:function(e,t){if(e.axes[2]>0){return t._applyDeadzoneMaximize(e.axes[2])}else{return 0}},RIGHT_TRIGGER:function(e,t){if(e.axes[2]<0){return t._applyDeadzoneMaximize(e.axes[2]*-1)}else{return 0}}}},LOGITECH_WEBKIT:{buttons:{A:1,B:2,X:0,Y:3,LB:4,RB:5,LEFT_TRIGGER:6,RIGHT_TRIGGER:7,LEFT_STICK:10,RIGHT_STICK:11,START:9,BACK:8,HOME:10,DPAD_UP:11,DPAD_DOWN:12,DPAD_LEFT:13,DPAD_RIGHT:14},axes:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3}},XBOX:{buttons:{A:0,B:1,X:2,Y:3,LB:4,RB:5,LEFT_TRIGGER:6,RIGHT_TRIGGER:7,LEFT_STICK:10,RIGHT_STICK:11,START:9,BACK:8,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15},axes:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3}}};Gamepad.prototype.init=function(){this.platform=this._resolvePlatform();switch(this.platform){case Gamepad.Platform.WEBKIT:this._setupWebkit();break;case Gamepad.Platform.FIREFOX:this._setupFirefox();break;case Gamepad.Platform.UNSUPPORTED:return false;break}if(typeof window.requestAnimationFrame=="undefined"){window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame}this._update();return true};Gamepad.prototype.bind=function(e,t){if(typeof this.listeners[e]=="undefined"){this.listeners[e]=[]}this.listeners[e].push(t);return this};Gamepad.prototype.count=function(){return this.gamepads.length};Gamepad.prototype._fire=function(e,t){if(typeof this.listeners[e]=="undefined"){return}for(var n=0;n<this.listeners[e].length;n++){this.listeners[e][n].apply(this.listeners[e][n],[t])}};Gamepad.prototype._resolvePlatform=function(){if(typeof navigator.webkitGamepads!="undefined"||typeof navigator.webkitGetGamepads!="undefined"){return Gamepad.Platform.WEBKIT}else{return Gamepad.Platform.FIREFOX}};Gamepad.prototype._setupWebkit=function(){};Gamepad.prototype._setupFirefox=function(){var e=this;window.addEventListener("MozGamepadConnected",function(t){e._connect(t.gamepad)});window.addEventListener("MozGamepadDisconnected",function(t){e._disconnect(t.gamepad)})};Gamepad.prototype._getMapping=function(e){switch(e){case Gamepad.Type.PLAYSTATION:if(this.platform==Gamepad.Platform.FIREFOX){return Gamepad.Mapping.PLAYSTATION_FIREFOX}else if(this.platform==Gamepad.Platform.WEBKIT){return Gamepad.Mapping.PLAYSTATION_WEBKIT}else{return null}break;case Gamepad.Type.LOGITECH:if(this.platform==Gamepad.Platform.FIREFOX){return Gamepad.Mapping.LOGITECH_FIREFOX}else if(this.platform==Gamepad.Platform.WEBKIT){return Gamepad.Mapping.LOGITECH_WEBKIT}else{return null}break;case Gamepad.Type.XBOX:return Gamepad.Mapping.XBOX;break}return null};Gamepad.prototype._connect=function(e){e.type=this._resolveControllerType(e.id);if(e.type==Gamepad.Type.UNSUPPORTED){this._fire(Gamepad.Event.UNSUPPORTED,e);return false}e.mapping=this._getMapping(e.type);if(e.mapping==null){this._fire(Gamepad.Event.UNSUPPORTED,e);return false}e.prevState={};e.state={};var t;for(t in e.mapping.buttons){e.state[t]=0;e.prevState[t]=0}for(t in e.mapping.axes){e.state[t]=0;e.prevState[t]=0}this.gamepads[e.index]=e;this._fire(Gamepad.Event.CONNECTED,e);return true};Gamepad.prototype._disconnect=function(e){var t=[],n;if(typeof this.gamepads[e.index]!="undefined"){delete this.gamepads[e.index]}for(n=0;n<this.gamepads.length;n++){if(typeof this.gamepads[n]!="undefined"){t[n]=this.gamepads[n]}}this.gamepads=t;this._fire(Gamepad.Event.DISCONNECTED,e)};Gamepad.prototype._resolveControllerType=function(e){e=e.toLowerCase();if(e.indexOf("playstation")!=-1){return Gamepad.Type.PLAYSTATION}else if(e.indexOf("logitech")!=-1||e.indexOf("wireless gamepad")!=-1){return Gamepad.Type.LOGITECH}else if(e.indexOf("xbox")!=-1){return Gamepad.Type.XBOX}else{return Gamepad.Type.UNSUPPORTED}};Gamepad.prototype._update=function(){var e=this,t,n,r,i;switch(this.platform){case Gamepad.Platform.WEBKIT:this._updateWebkit();break;case Gamepad.Platform.FIREFOX:this._updateFirefox();break}for(i=0;i<this.gamepads.length;i++){if(typeof this.gamepads[i]=="undefined"){continue}for(t in this.gamepads[i].mapping.buttons){n=this.gamepads[i].mapping.buttons[t];this.gamepads[i].prevState[t]=this.gamepads[i].state[t];if(typeof n=="function"){this.gamepads[i].state[t]=n(this.gamepads[i],this)}else{r=this.gamepads[i].buttons[n];if(typeof this.gamepads[i].buttons[n]!="undefined"){this.gamepads[i].state[t]=r}}if(this.gamepads[i].prevState[t]!=this.gamepads[i].state[t]){if(this.gamepads[i].state[t]==1){this._fire(Gamepad.Event.BUTTON_DOWN,{gamepadIndex:i,control:t})}else{this._fire(Gamepad.Event.BUTTON_UP,{gamepadIndex:i,control:t})}}}for(t in this.gamepads[i].mapping.axes){n=this.gamepads[i].mapping.axes[t];if(typeof n=="function"){this.gamepads[i].state[t]=n(this.gamepads[i],this)}else{r=this._applyDeadzoneMaximize(this.gamepads[i].axes[n]);if(typeof this.gamepads[i].axes[n]!="undefined"){this.gamepads[i].state[t]=r}}}}if(this.gamepads.length>0){this._fire(Gamepad.Event.TICK,this.gamepads)}window.requestAnimationFrame(function(){e._update()})};Gamepad.prototype._updateWebkit=function(){var e;if(typeof navigator.webkitGamepads=="object"){e=navigator.webkitGamepads}else if(typeof navigator.webkitGetGamepads=="function"){e=navigator.webkitGetGamepads()}else{return}if(e.length!=this.gamepads.length){var t,n;for(n=0;n<e.length;n++){t=e[n];if(typeof t!="undefined"&&typeof this.gamepads[t.index]=="undefined"){this._connect(t)}}for(n=0;n<this.gamepads.length;n++){if(typeof this.gamepads[n]!="undefined"&&typeof e[n]=="undefined"){this._disconnect(this.gamepads[n])}}}};Gamepad.prototype._updateFirefox=function(){};Gamepad.prototype._applyDeadzoneMaximize=function(e,t,n){t=typeof t!="undefined"?t:this.deadzone;n=typeof n!="undefined"?n:this.maximizeThreshold;if(e>=0){if(e<t){e=0}else if(e>n){e=1}}else{if(e>-t){e=0}else if(e<-n){e=-1}}return e}